<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Wealthica Rebalance Add-on</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <script type="text/javascript" src="https://wealthica.github.io/wealthica.js/dist/addon.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
</head>
<body>
<h3>This is the Wealthica Rebalance Add-on.</h3>
<p>Try some of the actions below:</p>
<p>
    <button type="button" id="getPositions">List Positions</button>
<!--    <button type="button" disabled="disabled" id="getPositions">List Positions</button>-->
</p>
<textarea id="data" rows="8" cols="100"></textarea>
<div id="result"></div>

<script type="text/javascript">
    var addon, addonOptions;

    $(function () {
        addon = new Addon();

        addon.on('init', function (options) {
            // Dashboard is ready and is signaling to the add-on that it should
            // render using the passed in options (filters, language, etc.)
            addonOptions = options;
            $('button').removeAttr('disabled');
            generateTable(addonOptions.data);
            // showAddonData(addonOptions.data, true);
        }).on('update', function (options) {
            // Filters have been updated and Dashboard is passing in updated options
            addonOptions = _.extend(addonOptions, options);
            generateTable(addonOptions.data);
            // showAddonData(addonOptions.data);
        });

        $('#getPositions').on('click', function () {
            $(this).attr('disabled', 'disabled');

            addon.api.getPositions(getQueryFromOptions(addonOptions)).then(function (response) {
                $('#result').html(generateTable(response));
            }).catch(function (err) {
                $('#result').html('Error:<br><code>' + err + '</code>');
            }).finally(function () {
                $('#getPositions').removeAttr('disabled');
            });
        });

        function generateTable(data) {
            var res_html = '<table><tr><th>Symbol</th><th>Units</th><th>Value</th><th>Percent</th></tr>';
            console.log(data);
            var tdata = [];
            var total_value = 0;

            for (const d in data) {
                console.log(d);
                let symbol = data[d]['security']['symbol'];
                let units = parseFloat(data[d]['quantity']);
                let price = parseFloat(data[d]['security']['last_price']);
                let value = parseFloat(data[d]['value']);

                total_value = total_value + value;
                tdata.push({'symbol': symbol, 'units': units, 'value': value});
            }

            for (const d in tdata) {
                let symbol = tdata[d]['symbol'];
                let units = tdata[d]['units'];
                let value = tdata[d]['value'];
                let percent = (value / total_value) * 100;
                res_html = res_html +
                    `<tr><th>${symbol}</th><th>${units}</th><th>${value}</th><th>${percent.toFixed(2)}</th></tr>`;
            }

            res_html = res_html +
                `<tr><th><b>TOTAL</b></th><th></th><th><b>${total_value}</b></th><th></th></tr>`;

            res_html = res_html + '</table>';
            return res_html;
        }

        // Show addon data in result box and optionally update the text input.
        function showAddonData(data, updateInput) {
            $('#result').html('Addon data:<br><code>' + JSON.stringify(data) + '</code>');
            if (updateInput && data) {
                $('#data').val(JSON.stringify(data));
            }
        }

        // Compose a query object from the addon options to pass to the API calls.
        function getQueryFromOptions(options) {
            return {
                from: options.dateRangeFilter && options.dateRangeFilter[0],
                to: options.dateRangeFilter && options.dateRangeFilter[1],
                groups: options.groupsFilter,
                institutions: options.institutionsFilter,
                investments: options.investmentsFilter === 'all' ? null : options.investmentsFilter,
            }
        }
    });
</script>

</body>
</html>